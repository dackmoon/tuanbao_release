<view class="schedule-container">
  <!-- é¡¶éƒ¨æ—¥å†é€‰æ‹©å™¨ -->
  <view class="calendar-header">
    <view class="month-selector">
      <view class="arrow" bindtap="prevMonth">ã€ˆ</view>
      <picker mode="multiSelector" bindchange="bindDateChange" value="{{[yearIndex, monthIndex]}}" range="{{[yearArray, monthArray]}}">
        <view class="current-month">{{year}}å¹´{{month}}æœˆ</view>
      </picker>
      <view class="arrow" bindtap="nextMonth">ã€‰</view>
    </view>
    
    <!-- æ˜ŸæœŸæŒ‡ç¤ºå™¨ -->
    <view class="weekdays">
      <view class="weekday" wx:for="{{weekdays}}" wx:key="index">{{item}}</view>
    </view>
    
    <!-- æ—¥å†ç½‘æ ¼ -->
    <view class="calendar-grid">
      <view class="day {{item.current ? 'current' : ''}} {{item.hasEvent ? 'has-event' : ''}} {{item.selected ? 'selected' : ''}}" 
            wx:for="{{days}}" 
            wx:key="index"
            bindtap="selectDay"
            data-day="{{item.day}}"
            data-index="{{index}}">
        <view class="day-number">{{item.day}}</view>
        <view class="day-indicator" wx:if="{{item.hasEvent}}"></view>
      </view>
    </view>
  </view>
  
  <!-- æ—¥ç¨‹åˆ—è¡¨ -->
  <view class="events-container">
    <view class="date-title">{{selectedDate}}</view>
    
    <block wx:if="{{dayEvents.length > 0}}">
      <view class="event-list">
        <view class="event-card" wx:for="{{dayEvents}}" wx:key="id">
          <view class="event-number">{{index + 1}}</view>
          <view class="event-time">{{item.eventTime || 'å…¨å¤©'}}</view>
          <view class="event-content">
            <view class="event-title-row">
              <text class="event-title">{{item.title}}</text>
              <view class="event-desc-container auto-scroll" wx:if="{{item.description && item.description !== 'æ— æè¿°'}}">
                <text class="event-desc">{{item.description}}</text>
              </view>
            </view>
          </view>
          <view class="event-actions">
            <view class="action-btn edit" bindtap="editEvent" data-id="{{item.id}}">
              <text class="action-icon">âœ</text>
            </view>
            <view class="action-btn delete" bindtap="deleteEvent" data-id="{{item.id}}">
              <text class="action-icon">âœ•</text>
            </view>
          </view>
        </view>
      </view>
    </block>
    
    <view class="empty-tip" wx:else>
      <image class="empty-image"></image>
      <view class="empty-text">ä»Šå¤©è¿˜æ²¡æœ‰å®‰æ’å“¦~</view>
    </view>
    
    <!-- æŒ‰é’®ç»„ -->
    <view class="btn-group">
      <!-- ä»»åŠ¡ç®¡ç†æŒ‰é’® -->
      <view class="task-mgmt-btn" bindtap="showTaskManagement">
        <view class="task-mgmt-icon">â˜°</view>
        <view class="task-mgmt-text">ä»»åŠ¡ç®¡ç†</view>
      </view>
      
      <!-- æ·»åŠ æŒ‰é’® -->
      <view class="add-btn" bindtap="showAddOptions">
        <view class="add-icon">+</view>
        <view class="add-text">æ·»åŠ æ—¥ç¨‹</view>
      </view>
    </view>
  </view>
  
  <!-- å¹´æœˆé€‰æ‹©å™¨å¼¹çª— -->
  <view class="year-month-picker" wx:if="{{showYearMonthPicker}}">
    <view class="picker-mask" bindtap="closeYearMonthSelector"></view>
    <view class="picker-content">
      <view class="picker-header">
        <view class="picker-title">é€‰æ‹©å¹´æœˆ</view>
        <view class="picker-close" bindtap="closeYearMonthSelector">Ã—</view>
      </view>
      
      <view class="year-selector">
        <view class="selector-title">å¹´ä»½</view>
        <scroll-view scroll-y class="year-list">
          <view class="year-item {{item === year ? 'active' : ''}}" 
                wx:for="{{yearRange}}" 
                wx:key="*this"
                bindtap="selectYear"
                data-year="{{item}}">
            {{item}}
          </view>
        </scroll-view>
      </view>
      
      <view class="month-selector-list">
        <view class="selector-title">æœˆä»½</view>
        <view class="month-list">
          <view class="month-item {{index + 1 === month ? 'active' : ''}}" 
                wx:for="{{12}}" 
                wx:key="index"
                bindtap="selectMonth"
                data-month="{{index + 1}}">
            {{index + 1}}æœˆ
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ–°çš„ç»Ÿä¸€æ·»åŠ æ—¥ç¨‹å¼¹çª— -->
  <view class="schedule-mask" wx:if="{{showAddOptions}}" bindtap="hideAddOptions" catchtouchmove="stopPropagation">
    <view class="schedule-modal-container" catchtap="stopPropagation" catchtouchmove="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="schedule-header">
        <view class="schedule-title">
          <text class="title-icon">ğŸ“…</text>
          <text class="title-text">{{editingEventId ? 'ç¼–è¾‘æ—¥ç¨‹' : 'æ·»åŠ æ—¥ç¨‹'}}</text>
        </view>
        <view class="schedule-close" bindtap="hideAddOptions">Ã—</view>
      </view>
      
      <!-- è¡¨å•å†…å®¹ -->
      <scroll-view scroll-y="true" class="schedule-form">
        <!-- ä¸»é¢˜è¾“å…¥ -->
        <view class="form-section">
          <view class="section-header">
            <text class="section-icon">âœï¸</text>
            <text class="section-title">ä¸»é¢˜</text>
            <text class="required-mark">*</text>
          </view>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥æ—¥ç¨‹æ ‡é¢˜" 
            bindinput="onScheduleTitleInput" 
            value="{{scheduleTitle}}"
            maxlength="50"
          />
        </view>
        
        <!-- æ—¶é—´é€‰æ‹© -->
        <view class="form-section">
          <view class="section-header">
            <text class="section-icon">â°</text>
            <text class="section-title">æ—¶é—´</text>
          </view>
          
          <!-- æ—¶é—´é€‰æ‹©å™¨ç»„ï¼ˆåŒä¸€è¡Œï¼‰ -->
          <view class="time-selector-group">
            <!-- æ—¥æœŸé€‰æ‹© -->
            <picker 
              mode="date" 
              value="{{scheduleDate}}" 
              bindchange="onScheduleDateChange"
              class="inline-time-picker date-picker"
            >
              <view class="inline-picker-display">{{scheduleDate}}</view>
            </picker>
            
            <!-- å¼€å§‹æ—¶é—´é€‰æ‹© -->
            <picker 
              range="{{timeOptions}}" 
              value="{{scheduleStartTimeIndex}}" 
              bindchange="onScheduleStartTimeChange"
              class="inline-time-picker"
            >
              <view class="inline-picker-display">{{scheduleStartTime}}</view>
            </picker>
            
            <!-- ç»“æŸæ—¶é—´é€‰æ‹© -->
            <picker 
              range="{{timeOptions}}" 
              value="{{scheduleEndTimeIndex}}" 
              bindchange="onScheduleEndTimeChange"
              class="inline-time-picker"
            >
              <view class="inline-picker-display">{{scheduleEndTime}}</view>
            </picker>
          </view>
        </view>
        
        <!-- é‡å¤é€‰æ‹© -->
        <view class="form-section">
          <view class="section-header">
            <text class="section-icon">ğŸ”„</text>
            <text class="section-title">é‡å¤</text>
          </view>
          <view class="repeat-options">
            <view 
              class="repeat-option {{repeatType === 'none' ? 'active' : ''}}" 
              bindtap="selectRepeatType" 
              data-type="none"
            >
              <text class="option-text">ä¸é‡å¤</text>
            </view>
            <view 
              class="repeat-option {{repeatType === 'daily' ? 'active' : ''}}" 
              bindtap="selectRepeatType" 
              data-type="daily"
            >
              <text class="option-text">æ¯å¤©</text>
              <text class="option-desc" wx:if="{{repeatType === 'daily'}}">ï¼ˆ30å¤©ï¼‰</text>
            </view>
            <view 
              class="repeat-option {{repeatType === 'weekly' ? 'active' : ''}}" 
              bindtap="selectRepeatType" 
              data-type="weekly"
            >
              <text class="option-text">æ¯å‘¨</text>
              <text class="option-desc" wx:if="{{repeatType === 'weekly'}}">ï¼ˆ4å‘¨ï¼‰</text>
            </view>
          </view>
        </view>
        
        <!-- æè¿°è¾“å…¥ -->
        <view class="form-section">
          <view class="section-header">
            <text class="section-icon">ğŸ“</text>
            <text class="section-title">æè¿°</text>
          </view>
          <textarea 
            class="form-textarea" 
            placeholder="æ·»åŠ æ—¥ç¨‹æè¿°ï¼ˆå¯é€‰ï¼‰" 
            bindinput="onScheduleDescInput" 
            value="{{scheduleDescription}}"
            maxlength="200"
            auto-height
          ></textarea>
        </view>
      </scroll-view>
      
      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="schedule-footer">
        <button class="btn cancel-btn" bindtap="cancelScheduleAdd">å–æ¶ˆ</button>
        <button class="btn save-btn" bindtap="saveNewSchedule">
          {{editingEventId ? 'ä¿å­˜ä¿®æ”¹' : 'ä¿å­˜'}}
        </button>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡ç®¡ç†å¼¹çª— -->
  <view class="task-mgmt-mask" wx:if="{{showTaskManagement}}" bindtap="hideTaskManagement" catchtouchmove="stopPropagation">
    <view class="task-mgmt-container" catchtap="stopPropagation" catchtouchmove="stopPropagation">
      <view class="task-mgmt-header">
        <view class="task-mgmt-title">ä»»åŠ¡ç®¡ç†</view>
        <view class="task-mgmt-actions">
          <view class="delete-all-btn" bindtap="deleteAllTasks" wx:if="{{allTasks.length > 0}}">
            ä¸€é”®åˆ é™¤
          </view>
          <view class="clear-all-data-btn" bindtap="clearAllData">
            æ¸…ç©ºæ‰€æœ‰æ•°æ®
          </view>
          <view class="task-mgmt-close" bindtap="hideTaskManagement">Ã—</view>
        </view>
      </view>
      
      <scroll-view scroll-y="true" class="task-mgmt-content">
        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <block wx:if="{{allTasks.length > 0}}">
          <view class="task-list">
            <view class="task-item" wx:for="{{allTasks}}" wx:key="_id">
              <view class="task-number">{{item.taskNumber}}</view>
              <view class="task-content">
                <view class="task-title">{{item.content || item.title}}</view>
                <view class="task-operation-info">
                  <text class="operation-type {{item.operationType === 'batch' ? 'batch-type' : 'single-type'}}">{{item.operationType === 'batch' ? 'æ‰¹é‡æ“ä½œ' : 'å•ä¸ªæ“ä½œ'}}</text>
                  <text class="schedule-count">åŒ…å« {{item.scheduleCount}} ä¸ªæ—¥ç¨‹</text>
                </view>
                <view class="task-date-range">æ—¶é—´èŒƒå›´ï¼š{{item.dateRange}}</view>
                <view class="task-create-time">åˆ›å»ºäºï¼š{{item.formattedCreateTime}}</view>
              </view>
              <view class="task-delete-btn" bindtap="deleteTaskFromManagement" data-id="{{item._id}}">
                <text class="delete-icon">Ã—</text>
              </view>
            </view>
          </view>
        </block>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="task-empty" wx:else>
          <view class="task-empty-icon">â–¡</view>
          <view class="task-empty-text">æš‚æ— ä»»åŠ¡</view>
          <view class="task-empty-desc">ç‚¹å‡»ä¸‹æ–¹"æ·»åŠ æ—¥ç¨‹"åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡</view>
        </view>
      </scroll-view>
    </view>
  </view>
</view> 