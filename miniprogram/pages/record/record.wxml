<view class="record-container">
  <!-- 搜索框 -->
  <view class="search-container">
    <view class="search-box">
      <image class="search-icon" src="/assert/icon/search.png" mode="aspectFit"></image>
      <input class="search-input" placeholder="搜索动态" bindinput="onSearchInput" confirm-type="search" bindconfirm="onSearch" value="{{searchKeyword}}"/>
      <view class="search-btn" bindtap="onSearch" wx:if="{{searchKeyword}}">搜索</view>
    </view>
  </view>
  
  <!-- 发布按钮 -->
  <view class="publish-btn" bindtap="showPublishModal">
    <image class="publish-icon" src="/assert/icon/add.png" mode="aspectFit"></image>
  </view>
  
  <!-- 动态列表 -->
  <scroll-view class="moments-list" scroll-y="true" bindscrolltolower="loadMoreMoments" refresher-enabled="true" refresher-triggered="{{isRefreshing}}" bindrefresherrefresh="onRefresh">
    <block wx:if="{{moments.length > 0}}">
      <view class="moment-item" wx:for="{{moments}}" wx:key="_id">
        <!-- 用户信息 -->
        <view class="moment-header">
          <image class="avatar" src="{{item.userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view class="user-info">
            <text class="nickname">{{item.userInfo.nickName}}</text>
            <text class="time">{{item.createTime}}</text>
          </view>
          <!-- 操作菜单 (对所有用户开放) -->
          <view class="moment-actions" catchtap="showActionSheet" data-id="{{item._id}}">
            <image class="action-icon" src="/assert/icon/more.png" mode="aspectFit"></image>
          </view>
        </view>
        
        <!-- 动态内容 -->
        <view class="moment-content" bindtap="navigateToDetail" data-id="{{item._id}}">
          <text class="content-text">{{item.content}}</text>
          
          <!-- 图片展示 -->
          <view class="image-container" wx:if="{{item.images && item.images.length > 0}}">
            <view class="image-grid-{{item.images.length > 4 ? 3 : (item.images.length > 1 ? 2 : 1)}}">
              <image 
                class="moment-image" 
                wx:for="{{item.images}}" 
                wx:for-item="image" 
                wx:key="index" 
                src="{{image}}" 
                mode="aspectFill"
                catchtap="previewImage"
                data-urls="{{item.images}}"
                data-current="{{image}}"
              ></image>
            </view>
          </view>
          
          <!-- 视频展示 -->
          <view class="video-container" wx:if="{{item.video}}">
            <video class="moment-video" src="{{item.video}}" object-fit="cover" show-center-play-btn="true"></video>
          </view>
        </view>
        
        <!-- 点赞和评论区域 -->
        <view class="moment-footer">
          <view class="moment-stats">
            <!-- 点赞按钮 -->
            <view class="like-btn {{item.isLiked ? 'liked' : ''}}" catchtap="toggleLike" data-id="{{item._id}}" data-index="{{index}}">
              <image class="like-icon" src="{{item.isLiked ? '/assert/icon/liked.png' : '/assert/icon/like.png'}}" mode="aspectFit"></image>
              <text class="like-count">{{item.likeCount || 0}}</text>
            </view>
            
            <!-- 评论按钮 -->
            <view class="comment-btn" catchtap="showCommentInput" data-id="{{item._id}}" data-index="{{index}}">
              <image class="comment-icon" src="/assert/icon/comment.png" mode="aspectFit"></image>
              <text class="comment-count">{{item.commentCount || 0}}</text>
            </view>
          </view>
          
          <!-- 点赞列表 -->
          <view class="likes-list" wx:if="{{item.likes && item.likes.length > 0}}">
            <image class="like-list-icon" src="/assert/icon/liked.png" mode="aspectFit"></image>
            <text class="like-list-text">{{item.likesText}}</text>
          </view>
          
          <!-- 评论列表预览 (显示前2条) -->
          <view class="comments-preview" wx:if="{{item.comments && item.comments.length > 0}}">
            <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="id" wx:if="{{index < 2}}">
              <text class="comment-user">{{comment.userInfo.nickName}}：</text>
              <text class="comment-text">{{comment.content}}</text>
            </view>
            <view class="view-more" wx:if="{{item.commentCount > 2}}" catchtap="navigateToDetail" data-id="{{item._id}}">
              查看全部{{item.commentCount}}条评论
            </view>
          </view>
        </view>
      </view>
    </block>
    
    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{moments.length === 0 && !isLoading}}">
      <image class="empty-icon" src="/assert/icon/empty.png" mode="aspectFit"></image>
      <text class="empty-text">暂无动态，快来发布第一条吧~</text>
    </view>
    
    <!-- 加载状态 -->
    <view class="loading-state" wx:if="{{isLoading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>
    
    <!-- 加载到底提示 -->
    <view class="load-all" wx:if="{{loadAll && moments.length > 0}}">
      <text class="load-all-text">已经到底啦~</text>
    </view>
  </scroll-view>
  
  <!-- 评论输入框 (固定在底部) -->
  <view class="comment-input-container" wx:if="{{showCommentInput}}">
    <input class="comment-input" placeholder="说点什么..." focus="{{showCommentInput}}" confirm-type="send" bindconfirm="submitComment" value="{{commentContent}}" bindinput="onCommentInput"/>
    <view class="send-btn" bindtap="submitComment">发送</view>
  </view>
  
  <!-- 发布动态弹窗 -->
  <view class="publish-modal" wx:if="{{showPublishModal}}">
    <view class="publish-mask" bindtap="hidePublishModal"></view>
    <view class="publish-content">
      <view class="publish-header">
        <text class="publish-title">发布动态</text>
        <view class="close-btn" bindtap="hidePublishModal">×</view>
      </view>
      
      <view class="publish-body">
        <!-- 身份选择 -->
        <view class="identity-selector">
          <view class="identity-row">
            <text class="identity-title">选择身份：</text>
            <view class="identity-options">
              <view class="identity-option {{newMoment.identity === 'baby' ? 'selected' : ''}}" bindtap="selectIdentity" data-identity="baby">
                <image class="identity-icon" src="/assert/icon/baby.png" mode="aspectFit"></image>
                <text class="identity-name">宝宝</text>
              </view>
              <view class="identity-option {{newMoment.identity === 'parent' ? 'selected' : ''}}" bindtap="selectIdentity" data-identity="parent">
                <image class="identity-icon" src="/assert/icon/parent.png" mode="aspectFit"></image>
                <text class="identity-name">父母</text>
              </view>
              <view class="identity-option {{newMoment.identity === 'family' ? 'selected' : ''}}" bindtap="selectIdentity" data-identity="family">
                <image class="identity-icon" src="/assert/icon/family.png" mode="aspectFit"></image>
                <text class="identity-name">家人</text>
              </view>
            </view>
          </view>
        </view>
        
        <textarea class="publish-textarea" placeholder="分享你的想法..." bindinput="onContentInput" value="{{newMoment.content}}" maxlength="500" auto-height></textarea>
        
        <view class="media-preview">
          <!-- 图片预览 -->
          <view class="image-preview-list" wx:if="{{newMoment.images.length > 0}}">
            <view class="image-preview-item" wx:for="{{newMoment.images}}" wx:key="index">
              <image class="preview-image" src="{{item}}" mode="aspectFill"></image>
              <view class="delete-image" catchtap="deleteImage" data-index="{{index}}">×</view>
            </view>
          </view>
          
          <!-- 视频预览 -->
          <view class="video-preview" wx:if="{{newMoment.video}}">
            <video class="preview-video" src="{{newMoment.video}}" object-fit="cover"></video>
            <view class="delete-video" catchtap="deleteVideo">×</view>
          </view>
        </view>
        
        <view class="media-actions">
          <view class="media-btn" bindtap="chooseImage">
            <image class="media-icon" src="/assert/icon/image.png" mode="aspectFit"></image>
            <text class="media-text">图片</text>
          </view>
          <view class="media-btn" bindtap="chooseVideo">
            <image class="media-icon" src="/assert/icon/video.png" mode="aspectFit"></image>
            <text class="media-text">视频</text>
          </view>
        </view>
      </view>
      
      <view class="publish-footer">
        <button class="publish-submit-btn" bindtap="publishMoment" disabled="{{!newMoment.content && newMoment.images.length === 0 && !newMoment.video || !newMoment.identity}}">发布</button>
      </view>
    </view>
  </view>
</view> 